<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Birthday Slide - Upper School</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: url('https://resources.finalsite.net/images/f_auto,q_auto/v1759264057/nuevaschoolorg/rpiggqhgnubricdf395m/BirthdayBackground.png');
      --text: #fff;
      --max-width: 1920px;
      --max-height: 1080px;
      --scroll-time: 40s;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: #000;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: #fff;
      overflow: hidden;
    }

    .stage {
      position: relative;
      margin: 0 auto;
      width: 100vw;
      height: 56.25vw;
      max-width: var(--max-width);
      max-height: var(--max-height);
      background-image: var(--bg);
      background-size: cover;
      background-position: center;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    @media (min-aspect-ratio: 16/9) {
      .stage { width: calc(100vh * 16 / 9); height: 100vh; }
    }

    .center-block {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      overflow: hidden;
    }

    .title {
      margin: 1vh 0 3vh;
      color: var(--text);
      font-weight: 800;
      font-size: clamp(48px, 8vh, 96px);
      text-shadow: 2px 2px 8px rgba(0,0,0,0.4);
    }

    .scroll-container {
      height: 45vh;
      overflow: hidden;
      position: relative;
      mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%);
      -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%);
    }

    .scroll-content {
      display: flex;
      flex-direction: column;
      animation: scrollLoop var(--scroll-time) linear infinite;
    }

    @keyframes scrollLoop {
      from { transform: translateY(0); }
      to   { transform: translateY(-50%); }
    }

    .names {
      list-style: none;
      margin: 0;
      padding: 0;
      text-align: center;
      line-height: 1.2;
    }

    .line {
      display: block;
      font-size: clamp(28px, 3.5vh, 48px);
      font-weight: 700;
      margin: 0.5em 0;
      white-space: nowrap;
    }

    .date-line {
      font-size: clamp(32px, 5vh, 60px);
      font-weight: 800;
      margin: 1em 0 0.3em;
      display: block;
    }

    .footer {
      text-align: center;
      color: #fff;
      font-size: clamp(12px, 1.5vh, 16px);
      opacity: 0.85;
      margin: 2vh 0;
    }
  </style>
</head>
<body>
  <div class="stage">
    <div class="center-block">
      <h1 class="title" id="title">Happy Birthday, Upper School!</h1>
      <div class="scroll-container">
        <div class="scroll-content" id="scrollContent">
          <div class="names" id="names"></div>
        </div>
      </div>
    </div>
    <div class="footer">
      Email hnall@nuevaschool.org for corrections or to opt out of birthday sharing
    </div>
  </div>

  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSCKgaZexTRAqU_kR0nZuLvPO7Pk7MAnOXB7Uk552LbbnzBsBpqIcWB4sxW6LR7_cIEcxTajkgQ1Zfe/pub?gid=301523703&single=true&output=csv";
    const REDIRECT_IMAGE_URL = "https://resources.finalsite.net/images/f_auto,q_auto,t_image_size_6/v1759264059/nuevaschoolorg/xsbsbt1z8yeiuvpcoemz/US_REDIRECT_IMG.jpg";

    function normalizeMMDD(str) {
      if (!str) return "";
      const parts = String(str).split("/");
      if (parts.length !== 2) return "";
      const m = parts[0].trim().padStart(2,"0");
      const d = parts[1].trim().padStart(2,"0");
      return `${m}/${d}`;
    }

    function parseCSV(text) {
      const rows = [];
      let i = 0, field = '', row = [], inQuotes = false;
      while (i < text.length) {
        const c = text[i];
        if (inQuotes) {
          if (c === '"') {
            if (text[i+1] === '"') { field += '"'; i += 2; continue; }
            inQuotes = false; i++; continue;
          } else { field += c; i++; continue; }
        } else {
          if (c === '"') { inQuotes = true; i++; continue; }
          if (c === ',') { row.push(field); field = ''; i++; continue; }
          if (c === '\r') { i++; continue; }
          if (c === '\n') { row.push(field); rows.push(row); field=''; row=[]; i++; continue; }
          field += c; i++; continue;
        }
      }
      if (field.length > 0 || row.length > 0) { row.push(field); rows.push(row); }
      return rows;
    }

    function normalizeHeader(h) {
      return h.replace(/^\uFEFF/, '').trim().toLowerCase().replace(/[\s_/]+/g, "");
    }

    function getRollingWeek() {
      const today = new Date(new Date().toLocaleString('en-US',{timeZone:'America/Los_Angeles'}));
      const dates = [];
      for (let i=0; i<7; i++) {
        const d = new Date(today);
        d.setDate(today.getDate() + i);
        dates.push(d);
      }
      return dates;
    }

    async function init() {
      let csvText = "";
      try {
        const res = await fetch(CSV_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        csvText = await res.text();
      } catch (e) {
        console.error("CSV fetch failed:", e);
        window.location.href = REDIRECT_IMAGE_URL;
        return;
      }

      let rows = [];
      try {
        rows = parseCSV(csvText);
      } catch (e) {
        console.error("CSV parse failed:", e);
        window.location.href = REDIRECT_IMAGE_URL;
        return;
      }
      if (!rows.length) { window.location.href = REDIRECT_IMAGE_URL; return; }

      const headers = rows[0].map(normalizeHeader);
      const nameIdx  = headers.indexOf("name");
      const gradeIdx = headers.indexOf("titlegrade");
      const dateIdx  = headers.indexOf("birthday");
      if (nameIdx < 0 || gradeIdx < 0 || dateIdx < 0) {
        console.error("Missing expected headers. Got:", headers);
        window.location.href = REDIRECT_IMAGE_URL;
        return;
      }

      const data = rows.slice(1).map(r => ({
        name: (r[nameIdx]  || "").trim(),
        grade: (r[gradeIdx] || "").trim(),
        date: normalizeMMDD(r[dateIdx])
      }));

      const dates = getRollingWeek();
      const todayStr = normalizeMMDD(`${dates[0].getMonth()+1}/${dates[0].getDate()}`);
      const grouped = [];

      dates.forEach(d => {
        const mmdd = `${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")}`;
        const matches = data.filter(r => r.date === mmdd);
        if (matches.length) {
          const labelBase = d.toLocaleDateString('en-US', {
            timeZone:'America/Los_Angeles',
            weekday:'long',
            month:'long',
            day:'numeric'
          });
          const label = (mmdd === todayStr)
            ? `ðŸŽˆ Today, ${labelBase} ðŸŽˆ`
            : labelBase;
          grouped.push({ label, matches });
        }
      });

      if (!grouped.length) {
        window.location.href = REDIRECT_IMAGE_URL;
        return;
      }

      const namesEl = document.getElementById("names");
      namesEl.innerHTML = "";

      grouped.forEach(day => {
        const dateLine = document.createElement("div");
        dateLine.className = "date-line";
        dateLine.textContent = day.label;
        namesEl.appendChild(dateLine);

        for (let i = 0; i < day.matches.length; i += 2) {
          const pair = day.matches.slice(i, i + 2)
            .map(r => `${r.name} â€“ ${r.grade}`)
            .join(", ");
          const isLast = i + 2 >= day.matches.length;
          const line = document.createElement("div");
          line.className = "line";
          line.textContent = isLast ? pair : pair + ",";
          namesEl.appendChild(line);
        }
      });

      // Clone the whole content once for seamless looping
      const scrollContent = document.getElementById("scrollContent");
      const clone = namesEl.cloneNode(true);
      scrollContent.appendChild(clone);

      // Adjust scroll duration (faster)
      const totalLines = namesEl.querySelectorAll(".line, .date-line").length
      const duration = Math.max(30, totalLines * 1);
      document.documentElement.style.setProperty("--scroll-time", `${duration}s`);
    }

    init();
  </script>
</body>
</html>
