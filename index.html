<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Birthday Slide - Upper School</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: url('https://resources.finalsite.net/images/f_auto,q_auto/v1759264057/nuevaschoolorg/rpiggqhgnubricdf395m/BirthdayBackground.png');
      --text: #fff;
      --subtext: #fff;
      --max-width: 1920px;
      --max-height: 1080px;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: #000;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: #fff;
    }

    .stage {
      position: relative;
      margin: 0 auto;
      width: 100vw;
      height: 56.25vw;
      max-width: var(--max-width);
      max-height: var(--max-height);
      background-image: var(--bg);
      background-size: cover;
      background-position: center;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    @media (min-aspect-ratio: 16/9) {
      .stage { width: calc(100vh * 16 / 9); height: 100vh; }
    }

    /* Center title + date + list as one block */
    .center-block {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .title {
      margin: 0;
      color: var(--text);
      font-weight: 800;
      font-size: clamp(48px, 8vh, 96px);
      text-shadow: none;
    }

    .date {
      margin: 1vh 0 4vh;
      color: var(--subtext);
      font-weight: 700;
      font-size: clamp(32px, 5vh, 60px);
      text-shadow: none;
    }

    .names {
      list-style: none;
      margin: 0;
      padding: 0;
      text-align: center;
      column-count: 1;
      column-gap: 4vw;
    }

    .names li {
      font-size: clamp(32px, 4.5vh, 56px);
      font-weight: 700;
      margin: 0.6em 0;
      break-inside: avoid;
      text-shadow: none;
    }

    .footer {
      text-align: center;
      color: #fff;
      font-size: clamp(12px, 1.5vh, 16px);
      opacity: 0.85;
      margin: 2vh 0;
    }
  </style>
</head>
<body>
  <div class="stage">
    <div class="center-block">
      <h1 class="title" id="title" hidden>Happy Birthday, Upper School!</h1>
      <p class="date" id="date" hidden></p>
      <ul class="names" id="names"></ul>
    </div>
    <div class="footer">
      Email hnall@nuevaschool.org for corrections or to opt out of birthday sharing
    </div>
  </div>

  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSCKgaZexTRAqU_kR0nZuLvPO7Pk7MAnOXB7Uk552LbbnzBsBpqIcWB4sxW6LR7_cIEcxTajkgQ1Zfe/pub?gid=301523703&single=true&output=csv";
    const REDIRECT_IMAGE_URL = "https://resources.finalsite.net/images/f_auto,q_auto,t_image_size_6/v1759264059/nuevaschoolorg/xsbsbt1z8yeiuvpcoemz/US_REDIRECT_IMG.jpg";

    function todayMMDD() {
      const la = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));
      return `${String(la.getMonth()+1).padStart(2,"0")}/${String(la.getDate()).padStart(2,"0")}`;
    }

    function formatTodayLong() {
      return new Date().toLocaleDateString('en-US', {
        timeZone: 'America/Los_Angeles', month: 'long', day: 'numeric'
      });
    }

    // Robust CSV parser (handles quotes and commas inside fields)
    function parseCSV(text) {
      const rows = [];
      let i = 0, field = '', row = [], inQuotes = false;
      while (i < text.length) {
        const c = text[i];
        if (inQuotes) {
          if (c === '"') {
            if (text[i+1] === '"') { field += '"'; i += 2; continue; }
            inQuotes = false; i++; continue;
          } else { field += c; i++; continue; }
        } else {
          if (c === '"') { inQuotes = true; i++; continue; }
          if (c === ',') { row.push(field); field = ''; i++; continue; }
          if (c === '\r') { i++; continue; }
          if (c === '\n') { row.push(field); rows.push(row); field=''; row=[]; i++; continue; }
          field += c; i++; continue;
        }
      }
      if (field.length > 0 || row.length > 0) { row.push(field); rows.push(row); }
      return rows;
    }

    // Normalize header: lowercase, remove spaces/underscores/slashes
    function normalizeHeader(h) {
      return h.replace(/^\uFEFF/, '').trim().toLowerCase().replace(/[\s_/]+/g, "");
    }

    // Normalize dates like "6/2" -> "06/02"
    function normalizeMMDD(str) {
      if (!str) return "";
      const parts = String(str).split("/");
      if (parts.length !== 2) return "";
      const m = parts[0].trim().padStart(2,"0");
      const d = parts[1].trim().padStart(2,"0");
      return `${m}/${d}`;
    }

    async function init() {
      let csvText = "";
      try {
        const res = await fetch(CSV_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        csvText = await res.text();
      } catch (e) {
        console.error("CSV fetch failed:", e);
        window.location.href = REDIRECT_IMAGE_URL;
        return;
      }

      let rows = [];
      try {
        rows = parseCSV(csvText);
      } catch (e) {
        console.error("CSV parse failed:", e);
        window.location.href = REDIRECT_IMAGE_URL;
        return;
      }
      if (!rows.length) { window.location.href = REDIRECT_IMAGE_URL; return; }

      const headers = rows[0].map(normalizeHeader);
      // Expecting: "name", "titlegrade", "birthday"
      const nameIdx  = headers.indexOf("name");
      const gradeIdx = headers.indexOf("titlegrade");
      const dateIdx  = headers.indexOf("birthday");
      if (nameIdx < 0 || gradeIdx < 0 || dateIdx < 0) {
        console.error("Missing expected headers. Got:", headers);
        window.location.href = REDIRECT_IMAGE_URL;
        return;
      }

      const data = rows.slice(1).map(r => ({
        name: (r[nameIdx]  || "").trim(),
        grade: (r[gradeIdx] || "").trim(),
        date: (r[dateIdx]  || "").trim()
      }));

      const today = todayMMDD();
      const todays = data.filter(r => normalizeMMDD(r.date) === today);

      if (!todays.length) {
        window.location.href = REDIRECT_IMAGE_URL;
        return;
      }

      // Render
      const titleEl = document.getElementById("title");
      const dateEl  = document.getElementById("date");
      const namesEl = document.getElementById("names");

      titleEl.hidden = false;
      dateEl.hidden = false;
      dateEl.textContent = formatTodayLong();

      namesEl.innerHTML = "";
      todays.forEach(r => {
        const li = document.createElement("li");
        li.textContent = `${r.name} - ${r.grade}`;
        namesEl.appendChild(li);
      });
    }

    init();
  </script>
</body>
</html>
